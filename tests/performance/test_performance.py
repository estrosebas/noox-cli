#!/usr/bin/env python3
"""
Pruebas de rendimiento para los m√≥dulos de NooxCLI.
Mide tiempos de respuesta, uso de memoria y eficiencia.
"""

import os
import sys
import time
import psutil
import platform
import subprocess
from pathlib import Path
from typing import Dict, List, Tuple
from datetime import datetime
import tracemalloc

# Agregar el directorio src al path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', '..', 'src'))

class PerformanceProfiler:
    """Clase para medir rendimiento de funciones."""
    
    def __init__(self):
        self.results = {}
        
    def measure_time(self, func, *args, **kwargs):
        """Mide el tiempo de ejecuci√≥n de una funci√≥n."""
        start_time = time.perf_counter()
        result = func(*args, **kwargs)
        end_time = time.perf_counter()
        execution_time = end_time - start_time
        return result, execution_time
    
    def measure_memory(self, func, *args, **kwargs):
        """Mide el uso de memoria de una funci√≥n."""
        tracemalloc.start()
        
        # Obtener memoria inicial
        process = psutil.Process()
        initial_memory = process.memory_info().rss
        
        # Ejecutar funci√≥n
        result = func(*args, **kwargs)
        
        # Obtener memoria final
        final_memory = process.memory_info().rss
        memory_diff = final_memory - initial_memory
        
        # Obtener estad√≠sticas de tracemalloc
        current, peak = tracemalloc.get_traced_memory()
        tracemalloc.stop()
        
        return result, {
            'memory_diff': memory_diff,
            'current_traced': current,
            'peak_traced': peak
        }
    
    def profile_function(self, func, name, *args, **kwargs):
        """Perfila una funci√≥n midiendo tiempo y memoria."""
        print(f"üìä Perfilando: {name}")
        
        # Medir tiempo
        result, exec_time = self.measure_time(func, *args, **kwargs)
        
        # Medir memoria
        _, memory_stats = self.measure_memory(func, *args, **kwargs)
        
        self.results[name] = {
            'execution_time': exec_time,
            'memory_stats': memory_stats,
            'success': True
        }
        
        print(f"  ‚è±Ô∏è Tiempo: {exec_time:.4f}s")
        print(f"  üíæ Memoria pico: {memory_stats['peak_traced'] / 1024 / 1024:.2f} MB")
        
        return result

def test_sistema_module_performance():
    """Prueba el rendimiento del m√≥dulo sistema."""
    print("\nüîß PRUEBAS DE RENDIMIENTO - M√ìDULO SISTEMA")
    print("-" * 50)
    
    profiler = PerformanceProfiler()
    
    try:
        from src.noox_cli.modules import sistema
        
        # Crear instancia del m√≥dulo
        sistema_module = sistema.SistemaModule()
        
        # Probar inicializaci√≥n
        profiler.profile_function(
            lambda: sistema.SistemaModule(),
            "Sistema - Inicializaci√≥n"
        )
        
        # Probar obtenci√≥n de informaci√≥n del sistema
        profiler.profile_function(
            sistema_module._get_system_info_fallback,
            "Sistema - Info del sistema (fallback)"
        )
        
        # Probar formateo de bytes
        profiler.profile_function(
            lambda: [sistema_module._format_bytes(i * 1024 * 1024) for i in range(1000)],
            "Sistema - Formateo de bytes (1000 iteraciones)"
        )
        
        # Probar parseo de memoria
        memory_strings = ["8,192 MB", "4 GB", "1024 KB"] * 100
        profiler.profile_function(
            lambda: [sistema_module._parse_memory_string(s) for s in memory_strings],
            "Sistema - Parseo de memoria (300 strings)"
        )
        
        # Probar obtenci√≥n de procesos (si psutil est√° disponible)
        try:
            import psutil
            profiler.profile_function(
                lambda: sistema_module._get_process_list(50),
                "Sistema - Lista de procesos (50 procesos)"
            )
        except ImportError:
            print("‚ö†Ô∏è psutil no disponible, saltando prueba de procesos")
        
    except Exception as e:
        print(f"‚ùå Error en pruebas de sistema: {e}")
    
    return profiler.results

def test_reparar_module_performance():
    """Prueba el rendimiento del m√≥dulo reparar."""
    print("\nüî® PRUEBAS DE RENDIMIENTO - M√ìDULO REPARAR")
    print("-" * 50)
    
    profiler = PerformanceProfiler()
    
    try:
        from src.noox_cli.modules import reparar
        
        # Crear instancia del m√≥dulo
        reparar_module = reparar.RepararModule()
        
        # Probar inicializaci√≥n
        profiler.profile_function(
            lambda: reparar.RepararModule(),
            "Reparar - Inicializaci√≥n"
        )
        
        # Probar generaci√≥n de contenido del perfil
        profiler.profile_function(
            reparar_module._get_profile_content,
            "Reparar - Generaci√≥n de contenido del perfil"
        )
        
        # Probar verificaci√≥n de oh-my-posh
        profiler.profile_function(
            reparar_module._check_omp_installation,
            "Reparar - Verificaci√≥n oh-my-posh"
        )
        
        # Probar generaci√≥n m√∫ltiple de contenido (stress test)
        profiler.profile_function(
            lambda: [reparar_module._get_profile_content() for _ in range(100)],
            "Reparar - Generaci√≥n m√∫ltiple (100 iteraciones)"
        )
        
    except Exception as e:
        print(f"‚ùå Error en pruebas de reparar: {e}")
    
    return profiler.results

def test_test_utf8_module_performance():
    """Prueba el rendimiento del m√≥dulo test_utf8."""
    print("\nüß™ PRUEBAS DE RENDIMIENTO - M√ìDULO TEST UTF-8")
    print("-" * 50)
    
    profiler = PerformanceProfiler()
    
    try:
        from src.noox_cli.modules import test_utf8
        
        # Crear instancia del m√≥dulo
        utf8_module = test_utf8.TestUtf8Module()
        
        # Probar inicializaci√≥n
        profiler.profile_function(
            lambda: test_utf8.TestUtf8Module(),
            "UTF-8 - Inicializaci√≥n"
        )
        
        # Probar verificaci√≥n de soporte de colores
        profiler.profile_function(
            utf8_module._check_color_support,
            "UTF-8 - Verificaci√≥n soporte de colores"
        )
        
        # Probar obtenci√≥n de codificaci√≥n de Python
        profiler.profile_function(
            utf8_module._get_python_encoding,
            "UTF-8 - Obtenci√≥n codificaci√≥n Python"
        )
        
        # Probar verificaci√≥n m√∫ltiple de colores (stress test)
        profiler.profile_function(
            lambda: [utf8_module._check_color_support() for _ in range(1000)],
            "UTF-8 - Verificaci√≥n colores (1000 iteraciones)"
        )
        
        # Probar informaci√≥n de codificaci√≥n en Windows
        if platform.system() == "Windows":
            profiler.profile_function(
                utf8_module._get_powershell_encoding,
                "UTF-8 - Codificaci√≥n PowerShell"
            )
        
    except Exception as e:
        print(f"‚ùå Error en pruebas de test_utf8: {e}")
    
    return profiler.results

def test_config_module_performance():
    """Prueba el rendimiento del m√≥dulo config."""
    print("\n‚öôÔ∏è PRUEBAS DE RENDIMIENTO - M√ìDULO CONFIG")
    print("-" * 50)
    
    profiler = PerformanceProfiler()
    
    try:
        from src.noox_cli.modules import config
        
        # Crear instancia del m√≥dulo
        config_module = config.ConfigModule()
        
        # Probar inicializaci√≥n
        profiler.profile_function(
            lambda: config.ConfigModule(),
            "Config - Inicializaci√≥n"
        )
        
        # Probar obtenci√≥n de p√°gina de c√≥digos
        profiler.profile_function(
            config_module._get_current_codepage,
            "Config - P√°gina de c√≥digos actual"
        )
        
        # Probar obtenci√≥n de codificaci√≥n de Python
        profiler.profile_function(
            config_module._get_python_encoding,
            "Config - Codificaci√≥n Python"
        )
        
        # Probar obtenci√≥n de codificaci√≥n de PowerShell
        profiler.profile_function(
            config_module._get_powershell_encoding,
            "Config - Codificaci√≥n PowerShell"
        )
        
        # Probar obtenci√≥n m√∫ltiple de p√°gina de c√≥digos (stress test)
        profiler.profile_function(
            lambda: [config_module._get_current_codepage() for _ in range(100)],
            "Config - P√°gina c√≥digos (100 iteraciones)"
        )
        
        # Probar configuraci√≥n del registro en Windows
        if platform.system() == "Windows":
            profiler.profile_function(
                config_module._get_registry_config,
                "Config - Configuraci√≥n del registro"
            )
        
    except Exception as e:
        print(f"‚ùå Error en pruebas de config: {e}")
    
    return profiler.results

def test_menu_system_performance():
    """Prueba el rendimiento del sistema de men√∫s."""
    print("\nüìã PRUEBAS DE RENDIMIENTO - SISTEMA DE MEN√öS")
    print("-" * 50)
    
    profiler = PerformanceProfiler()
    
    try:
        from src.noox_cli.menu import NooxMenu
        
        # Probar inicializaci√≥n del men√∫
        profiler.profile_function(
            lambda: NooxMenu("Test Menu"),
            "Menu - Inicializaci√≥n"
        )
        
        menu = NooxMenu("Test Menu")
        
        # Probar creaci√≥n de m√∫ltiples men√∫s
        profiler.profile_function(
            lambda: [NooxMenu(f"Menu {i}") for i in range(100)],
            "Menu - Creaci√≥n m√∫ltiple (100 men√∫s)"
        )
        
        # Probar m√©todos de mensaje
        profiler.profile_function(
            lambda: [menu.show_info(f"Mensaje {i}") for i in range(100)],
            "Menu - Mensajes info (100 mensajes)"
        )
        
    except Exception as e:
        print(f"‚ùå Error en pruebas de men√∫: {e}")
    
    return profiler.results

def test_startup_performance():
    """Prueba el rendimiento de inicio de la aplicaci√≥n."""
    print("\nüöÄ PRUEBAS DE RENDIMIENTO - INICIO DE APLICACI√ìN")
    print("-" * 50)
    
    profiler = PerformanceProfiler()
    
    try:
        # Probar importaci√≥n de m√≥dulos
        profiler.profile_function(
            lambda: __import__('src.noox_cli.modules.sistema', fromlist=['']),
            "Startup - Importaci√≥n m√≥dulo sistema"
        )
        
        profiler.profile_function(
            lambda: __import__('src.noox_cli.modules.reparar', fromlist=['']),
            "Startup - Importaci√≥n m√≥dulo reparar"
        )
        
        profiler.profile_function(
            lambda: __import__('src.noox_cli.modules.test_utf8', fromlist=['']),
            "Startup - Importaci√≥n m√≥dulo test_utf8"
        )
        
        profiler.profile_function(
            lambda: __import__('src.noox_cli.modules.config', fromlist=['']),
            "Startup - Importaci√≥n m√≥dulo config"
        )
        
        # Probar importaci√≥n completa
        def import_all_modules():
            from src.noox_cli.modules import sistema, reparar, test_utf8, config
            from src.noox_cli.menu import NooxMenu
            return sistema, reparar, test_utf8, config, NooxMenu
        
        profiler.profile_function(
            import_all_modules,
            "Startup - Importaci√≥n completa"
        )
        
    except Exception as e:
        print(f"‚ùå Error en pruebas de startup: {e}")
    
    return profiler.results

def analyze_performance_results(all_results: Dict[str, Dict]):
    """Analiza los resultados de rendimiento y genera recomendaciones."""
    print("\nüìä AN√ÅLISIS DE RENDIMIENTO")
    print("=" * 50)
    
    # Recopilar todas las m√©tricas
    all_times = []
    all_memory = []
    slow_functions = []
    memory_heavy_functions = []
    
    for module_name, results in all_results.items():
        print(f"\nüì¶ {module_name.upper()}:")
        
        for func_name, metrics in results.items():
            if metrics.get('success', False):
                exec_time = metrics['execution_time']
                memory_peak = metrics['memory_stats']['peak_traced']
                
                all_times.append(exec_time)
                all_memory.append(memory_peak)
                
                print(f"  {func_name}:")
                print(f"    ‚è±Ô∏è Tiempo: {exec_time:.4f}s")
                print(f"    üíæ Memoria: {memory_peak / 1024 / 1024:.2f} MB")
                
                # Identificar funciones lentas (>1 segundo)
                if exec_time > 1.0:
                    slow_functions.append((func_name, exec_time))
                
                # Identificar funciones que usan mucha memoria (>50 MB)
                if memory_peak > 50 * 1024 * 1024:
                    memory_heavy_functions.append((func_name, memory_peak))
    
    # Estad√≠sticas generales
    if all_times:
        avg_time = sum(all_times) / len(all_times)
        max_time = max(all_times)
        min_time = min(all_times)
        
        print(f"\nüìà ESTAD√çSTICAS DE TIEMPO:")
        print(f"  Promedio: {avg_time:.4f}s")
        print(f"  M√°ximo: {max_time:.4f}s")
        print(f"  M√≠nimo: {min_time:.4f}s")
    
    if all_memory:
        avg_memory = sum(all_memory) / len(all_memory)
        max_memory = max(all_memory)
        min_memory = min(all_memory)
        
        print(f"\nüíæ ESTAD√çSTICAS DE MEMORIA:")
        print(f"  Promedio: {avg_memory / 1024 / 1024:.2f} MB")
        print(f"  M√°ximo: {max_memory / 1024 / 1024:.2f} MB")
        print(f"  M√≠nimo: {min_memory / 1024 / 1024:.2f} MB")
    
    # Recomendaciones
    print(f"\nüí° RECOMENDACIONES:")
    
    if slow_functions:
        print(f"‚ö†Ô∏è Funciones lentas detectadas:")
        for func_name, exec_time in sorted(slow_functions, key=lambda x: x[1], reverse=True):
            print(f"  - {func_name}: {exec_time:.4f}s")
        print("  üí° Considera optimizar estas funciones o agregar indicadores de progreso")
    
    if memory_heavy_functions:
        print(f"‚ö†Ô∏è Funciones con alto uso de memoria:")
        for func_name, memory in sorted(memory_heavy_functions, key=lambda x: x[1], reverse=True):
            print(f"  - {func_name}: {memory / 1024 / 1024:.2f} MB")
        print("  üí° Considera optimizar el uso de memoria o implementar liberaci√≥n expl√≠cita")
    
    if not slow_functions and not memory_heavy_functions:
        print("‚úÖ Todas las funciones tienen buen rendimiento")
    
    # Puntuaci√≥n general
    performance_score = 100
    
    # Penalizar funciones lentas
    performance_score -= len(slow_functions) * 10
    
    # Penalizar uso excesivo de memoria
    performance_score -= len(memory_heavy_functions) * 5
    
    # Asegurar que la puntuaci√≥n no sea negativa
    performance_score = max(0, performance_score)
    
    print(f"\nüéØ PUNTUACI√ìN DE RENDIMIENTO: {performance_score}/100")
    
    if performance_score >= 90:
        print("üèÜ EXCELENTE - Rendimiento √≥ptimo")
    elif performance_score >= 80:
        print("‚úÖ BUENO - Rendimiento aceptable")
    elif performance_score >= 70:
        print("‚ö†Ô∏è REGULAR - Necesita algunas optimizaciones")
    else:
        print("‚ùå POBRE - Requiere optimizaciones importantes")
    
    return performance_score

def main():
    """Funci√≥n principal de las pruebas de rendimiento."""
    # Configurar UTF-8 para evitar errores de codificaci√≥n
    if platform.system() == "Windows":
        os.system('chcp 65001 > nul')
    
    print("SUITE DE PRUEBAS DE RENDIMIENTO - NooxCLI")
    print("=" * 60)
    
    start_time = time.time()
    
    # Informaci√≥n del sistema
    print(f"üíª Sistema: {platform.system()} {platform.release()}")
    print(f"üêç Python: {platform.python_version()}")
    print(f"‚öôÔ∏è Procesador: {platform.processor()}")
    
    if hasattr(psutil, 'cpu_count'):
        print(f"üî¢ CPUs: {psutil.cpu_count()}")
    
    if hasattr(psutil, 'virtual_memory'):
        memory = psutil.virtual_memory()
        print(f"üíæ Memoria: {memory.total / 1024 / 1024 / 1024:.1f} GB")
    
    # Ejecutar todas las pruebas de rendimiento
    all_results = {}
    
    # Pruebas de startup
    startup_results = test_startup_performance()
    if startup_results:
        all_results['startup'] = startup_results
    
    # Pruebas del sistema de men√∫s
    menu_results = test_menu_system_performance()
    if menu_results:
        all_results['menu'] = menu_results
    
    # Pruebas de m√≥dulos individuales
    sistema_results = test_sistema_module_performance()
    if sistema_results:
        all_results['sistema'] = sistema_results
    
    reparar_results = test_reparar_module_performance()
    if reparar_results:
        all_results['reparar'] = reparar_results
    
    utf8_results = test_test_utf8_module_performance()
    if utf8_results:
        all_results['test_utf8'] = utf8_results
    
    config_results = test_config_module_performance()
    if config_results:
        all_results['config'] = config_results
    
    # Analizar resultados
    performance_score = analyze_performance_results(all_results)
    
    # Tiempo total de ejecuci√≥n
    total_time = time.time() - start_time
    print(f"\n‚è±Ô∏è Tiempo total de pruebas: {total_time:.2f}s")
    
    # Retornar c√≥digo de salida basado en la puntuaci√≥n
    return 0 if performance_score >= 70 else 1

if __name__ == '__main__':
    sys.exit(main())